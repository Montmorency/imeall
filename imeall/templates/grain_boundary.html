{% extends "layout.html" %}

 <style>
    .node rect {
      cursor: pointer;
      fill: #fff;
      fill-opacity: .5;
      stroke: #3182bd;
      stroke-width: 1.5px;
    }
    .node text {
      font: 10px sans-serif;
      pointer-events: none;
    }
    path.link {
      fill: none;
      stroke: #9ecae1;
      stroke-width: 1.5px;
    }
</style>

{% block body %}
  <h2> Grain Boundary Structure </h2>
  <h3> {{ gbid }} </h3>
  <ul>
    <li> Grain Boundary Type:  <em> {{ gb_info.type }}</em>      </li>
    <li> Orientation Axis:     [{{ gb_info.orientation_axis | join(' ')  }}]  </li>
    <li> Boundary Plane:       [{{ gb_info.boundary_plane | join(' ') }}]  </li>
    <li> (Mis)Orientation Angle: {{ (gb_info.angle*(180.0/3.14159265)) | round(3,'floor') }}      </li>
    <li> Number of Atoms in Unit Cell: {{ gb_info.n_at }}      </li>
    <li> Coincident Sites:             {{ gb_info.coincident_sites }}      </li>
    <li> Sigma({{ (gb_info.n_at/gb_info.coincident_sites) | round(2, 'floor') }})</li>
  </ul>
  <img src = "{{url_for('serve_img', filename=url_path, gbid=gbid, img_type='struct')}}" alt="GB structure" width=700>
	<h2> Coincident Site Lattice  </h2>
  <img src = "{{url_for('serve_img', filename=url_path, gbid=gbid, img_type='csl')}}" alt="GB structure" width=700>
{#
  <div id="subgraineners">
  <p> <button id="subgrainbutton"> Show/Hide Subgrain Energetics </button> </p>
  <script>
    $("#subgrainbutton").click(function() {
        $("#subgraineners").toggle();
      });
  </script>
    <ul>
      {% if 'E_gb' in gb_info %} 
        <li> Number of Atoms in Unit Cell:  {{ gb_info.n_unit_cell }}                        </li>
      {% else %}
        <li> Number of Atoms in Unit Cell:  {{ gb_info.n_at }}                        </li>
      {% endif %}
      {% if 'E_gb' in gb_info %} 
        <li> Total Energy:                  {{ gb_info.E_gb | round(3,'floor') }} eV </li>
        <li> Total Energy per Atom:         {{ (gb_info.E_gb/gb_info.n_at) | round(3,'floor') }} eV </li>
      {% endif %}
    </ul> #}
{# Should convert this to java view.            #}
{# Collapsible indented tree layout taken from
   http://bl.ocks.org/mbostock/1093025          #}
  <h3> Subgrain Properties </h3>
  <script>
$( document ).ready( function(){
  
    var graindata = jQuery.parseJSON('{{subgrainsj|safe}}');
    var dataByPot = d3.nest()
                      .key(function(d) {return d.param_file;})
                      .entries(graindata);
    var dataTree = {'Subgrains':dataByPot}

{#Pattern to split data into name, .children: http://jsfiddle.net/pleaseteachmehowtodoit/CB38d/#}
    var root = { "key":"Subgrains",
                 "values": d3.nest()
                         .key(function(d){return d.param_file;})
                         .entries(graindata)
                }; 
    var root = {
      "name" : "Subgrains",
      "children" : root.values.map(function (pot){
       console.log(pot)
       return {"name": pot.key, 
               "children": pot.values.map(function(grain){ 
                return{"name":grain.gbid, "children":{"name": grain.E_gb, 
                "children":{"name":"thing", "children":grain.A}}};//end map grain
        })
      };
    }) //end map pot
   };

  var margin = {top: 30, right: 20, bottom: 30, left: 20},
      width = 960 - margin.left - margin.right,
      barHeight = 20,
      barWidth = width * .8;
  
  var i = 0,
      duration = 400,
      root;
  
  var tree = d3.layout.tree()
      .nodeSize([0, 20]);
  
  var diagonal = d3.svg.diagonal()
      .projection(function(d) { return [d.y, d.x]; });
  
  var svg = d3.select(".page").append("svg")
      .attr("width", width + margin.left + margin.right)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  root.x0 = 0;
  root.y0 = 0;
  update(root = root)

  function update(source) {
  // Compute the flattened node list. TODO use d3.layout.hierarchy.
    var nodes = tree.nodes(root);
    var height = Math.max(500, nodes.length * barHeight + margin.top + margin.bottom);

    d3.select("svg").transition()
        .duration(duration)
        .attr("height", height);

    d3.select(self.frameElement).transition()
        .duration(duration)
        .style("height", height + "px");

  // Compute the "layout".
    nodes.forEach(function(n, i) {
      n.x = i * barHeight;
    });

  // Update the nodes…
  var node = svg.selectAll("g.node")
      .data(nodes, function(d) { return d.id || (d.id = ++i); });

  var nodeEnter = node.enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
      .style("opacity", 1e-6);

  // Enter any new nodes at the parent's previous position.
  nodeEnter.append("rect")
      .attr("y", -barHeight / 2)
      .attr("height", barHeight)
      .attr("width", barWidth)
      .style("fill", color)
      .on("click", click);

  nodeEnter.append("text")
      .attr("dy", 3.5)
      .attr("dx", 5.5)
      .text(function(d) { return d.name; });

// Transition nodes to their new position.
  nodeEnter.transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
      .style("opacity", 1);

  node.transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
      .style("opacity", 1)
     .select("rect")
      .style("fill", color);

    // Transition exiting nodes to the parent's new position.
  node.exit().transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
      .style("opacity", 1e-6)
      .remove();

  // Update the links…
  var link = svg.selectAll("path.link")
      .data(tree.links(nodes), function(d) { return d.target.id; });

  // Enter any new links at the parent's previous position.
  link.enter()
      .insert("path", "g")
      .attr("class", "link")
      .attr("d", function(d) {
        var o = {x: source.x0, y: source.y0};
        return diagonal({source: o, target: o});
      })
    .transition()
      .duration(duration)
      .attr("d", diagonal);
// Transition links to their new position.
  link.transition()
      .duration(duration)
      .attr("d", diagonal);
// Transition exiting nodes to the parent's new position.
  link.exit().transition()
      .duration(duration)
      .attr("d", function(d) {
        var o = {x: source.x, y: source.y};
        return diagonal({source: o, target: o});
      })
      .remove();
// Stash the old positions for transition.
   nodes.forEach(function(d) {
     d.x0 = d.x;
     d.y0 = d.y;
   });
  }
// Toggle children on click.
  function click(d) {
      if (d.children) {
         d._children = d.children;
         d.children = null;
      } else {
         d.children = d._children;
         d._children = null;
      }
      update(d);
    }
    function color(d) {
      return d._children ? "#3182bd" : d.children ? "#c6dbef" : "#fd8d3c";
    }
  });
  </script>
  </div>
  <h3> Subgrain Directories of {{gbid}}: </h3> 
  <p> <button id="subgraindirbutton"> Show/Hide Subgrain Subdirectories </button> </p>
  <script>
    $("#subgraindirbutton").click(function() {
        $("#subgraindirs").toggle();
      });
  </script>
  <div id="subgraindirs">
    <ul>
      {%- for item in tree.children recursive %}
        <li><a href="{{url_for('serve_file', gbid=gbid, filename=item.name, 
                       url_path=url_path, textpath=item.fullpath)}}">{{item.name}}</a>
        {%- if item.children -%}
          <ul class="submenu">{{loop(item.children)}}</ul>
        {%- endif %}</li>
      {%- endfor %}
    </ul>
  </div>
  <h3> Fracture Simulations </h3>
{% endblock body %}
